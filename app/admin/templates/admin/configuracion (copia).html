{% extends "admin/base.html" %}

{% block title %}
Admin Dashboard - LUDOC-shop
{% endblock %}

{% block content %}
<div class="container my-4">

    <!-- Mostrar mensajes de flash -->
    {% with msgs = get_flashed_messages(with_categories=True) %}
    {% for c, msg in msgs %}
    <div class="alert {{ 'alert-danger' if c == 'error' else 'alert-success' }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endwith %}

    <!-- Botón para abrir el modal -->
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#userModal">
        Gestionar Usuarios
    </button>

    <!-- Tabla de usuarios -->
    <table id="userTable" class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.phone }}</td>
                <td>
                    <span class="badge {{ 'bg-success' if user.email_confirmed else 'bg-danger' }}">
                        {{ 'Activo' if user.email_confirmed else 'Inactivo' }}
                    </span>
                </td>
                <td>
                    <button class="btn btn-warning edit-user"
                            data-id="{{ user.id }}"
                            data-name="{{ user.name }}"
                            data-email="{{ user.email }}"
                            data-phone="{{ user.phone }}"
                            data-membership-duration="{{ user.membership_duration }}">
                        Editar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de gestión de usuarios -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="userForm" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" id="userId">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="userName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="userPhone" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="userPhone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="membershipDuration" class="form-label">Duración de la Membresía</label>
                        <select class="form-select" id="membershipDuration" name="membership_duration" required>
                            <option value="30">1 Mes</option>
                            <option value="90">3 Meses</option>
                            <option value="180">6 Meses</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Inicializar DataTable
        const table = $('#userTable').DataTable();
    
        // Abrir el modal con datos del usuario
        $(document).on('click', '.edit-user', function () {
            $('#userId').val($(this).data('id'));
            $('#userName').val($(this).data('name'));
            $('#userEmail').val($(this).data('email'));
            $('#userPhone').val($(this).data('phone'));
            $('#membershipDuration').val($(this).data('membership-duration'));
            $('#userModal').modal('show');
        });
    
        // Manejar la acción de guardar el formulario
        $('#userForm').on('submit', function (e) {
            e.preventDefault(); // Prevenir el envío predeterminado
    
            const userId = $('#userId').val();
            const formData = $(this).serialize();
    
            $.ajax({
                url: `/admin/update_user/${userId}`, // Ruta dinámica con el ID del usuario
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        alert(response.message); // Mensaje de éxito
                        $('#userModal').modal('hide'); // Cierra el modal
    
                        // Actualiza la tabla sin recargar la página
                        $('#userTableBody').html(response.updatedTable);
                        table.destroy();
                        $('#userTable').DataTable(); // Reinicia DataTable
                    } else {
                        alert(response.message); // Mensaje de error
                    }
                },
                error: function (xhr) {
                    alert('Error: ' + xhr.responseJSON.message); // Manejo de errores
                }
            });
        });
    });
    </script>
    
{% endblock %}