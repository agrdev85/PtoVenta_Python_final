{% extends "admin/base.html" %}

{% block title %}
Admin Dashboard - CuBaro
{% endblock %}

{% block content %}
<!-- Incluye SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container-fluid">

    <!-- Mostrar mensajes de flash -->
    {% with msgs = get_flashed_messages(with_categories=True) %}
    {% for c, msg in msgs %}
    <div class="alert alert-{{ 'danger' if c == 'error' else 'success' }}">
        {{ msg }}
    </div>
    {% endfor %}
    {% endwith %}
    
    <div class="d-flex justify-content-end mb-3">
        <div class="add-new btn-success btn">
           <a href="{{ url_for('register') }}" data-toggle="tooltip" title="Añadir Empleado" class="text-light">
              <i class="bi bi-person-plus"></i>
           </a>
        </div>
      </div>

    <!-- Tabla de usuarios -->
    <div class="table-responsive">
        <table id="userTable" class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>User</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Estado</th>
                    <th>Membresía</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.name }}</td>
                    <td>
                        <span class="badge {{ 'badge-success' if user.admin else 'badge-danger' }}">
                            {% if current_user.id == 1 and not user.admin %}
                                Empleado + {{ user['creator_name'] if user['creator_name'] else 'Sin Admin' }}
                            {% else %}
                                {{ 'Admin' if user.admin else 'Empleado' }}
                            {% endif %}
                        </span>                              
                    </td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.phone }}</td>
                    <td>
                        <span class="badge {{ 'badge-success' if user.email_confirmed else 'badge-danger' }}">
                            {{ 'Enable' if user.email_confirmed else 'Disable' }}
                        </span>
                    </td>
                    <td>
                        {% if user.membership_expiration %}
                            {{ user.membership_expiration.strftime('%Y-%m-%d') }}
                        {% else %}
                            Sin Membresía
                        {% endif %}
                    </td>
                    <td>
                        {% if user.membership %}
                            {{ user.membership.name }}  <!-- Mostrar el nombre de la membresía -->
                        {% else %}
                            Sin Membresía
                        {% endif %}
                    </td>               
                    <td>
                        <a href="#" class="edit-user" data-id="{{ user.id }}" data-name="{{ user.name }}" data-email="{{ user.email }}"
                            data-phone="{{ user.phone }}" data-registration-date="{{ user.registration_date }}" data-membership-expiration="{{ user.membership_expiration }}"
                            data-membership-id="{{ user.membership_id }}"> <!-- Asegúrate de que esto esté correctamente asignado -->
                            <i class="bi bi-pencil-square text-success"></i>
                        </a>
                        <a href="{{ url_for('admin.delete_user', id=user.id) }}" onclick="return confirm('¿Estás seguro de que deseas eliminar al usuario {{ user.name }}?');"><i class="bi bi-trash3 text-danger"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de gestión de usuarios -->
<div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="userForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Editar Usuario</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="userId" name="user_id">
                    <div class="form-group">
                        <label for="userName">Nombre</label>
                        <input type="text" class="form-control" id="userName" name="name" maxlength="12" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" class="form-control" id="userEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="userPhone">Teléfono</label>
                        <input type="text" class="form-control" id="userPhone" name="phone" maxlength="8" pattern="\d{8}" title="El teléfono debe tener exactamente 8 dígitos." required>
                    </div>
                    <div class="form-group position-relative">
                        <label for="password">Nueva Contraseña</label>
                        <input type="password" class="form-control" id="password" name="password" pattern="^[a-zA-Z0-9_\-&$@#!%^*+.]{8,30}$" title="La contraseña debe tener entre 8 y 30 caracteres y puede contener letras, números y símbolos.">
                        <span onclick="togglePassword('password', 'toggleIcon')" class="position-absolute" style="top: 38px; right: 15px; cursor: pointer; color:rgb(14, 66, 238);">
                            <i class="fa fa-eye toggle-icon" id="toggleIcon" title="Mostrar contraseña"></i>
                        </span>
                    </div>
                    {% if current_user.id == 1 %}
                    <div class="form-group">
                        <label for="registrationDate">Fecha de Registro</label>
                        <input type="date" class="form-control" id="registrationDate" name="registration_date" readonly>
                    </div>
                    <div class="form-group">
                        <label for="membershipExpiration">Fecha de Vencimiento de Membresía</label>
                        <input type="date" class="form-control" id="membershipExpiration" name="membership_expiration" required>
                    </div>
                    <div class="form-group">
                        <label for="membership">Tipo de Membresía</label>
                        <select class="form-control" name="membership_id" id="membership" required>
                            {% for membership in memberships %}
                                <option value="{{ membership.id }}" {% if membership.id == user.membership_id %} selected {% endif %}>
                                    {{ membership.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
    const table = $('#userTable').DataTable({
        "lengthMenu": [5, 10, 25, 50],
        "ordering": true,
        "searching": true,
        "paging": true,
        "info": true,
        "columnDefs": [
            {
                "targets": 0, // Índice de la columna "Order ID"
                "visible": false, // Oculta la columna
                "searchable": false // También evita que sea buscable
            }
        ]
    });

    // Mostrar datos del usuario en el modal
    $(document).on('click', '.edit-user', function () {
    const userId = $(this).data('id');
    const userName = $(this).data('name');
    const userEmail = $(this).data('email');
    const userPhone = $(this).data('phone');
    const registrationDate = $(this).data('registrationDate'); // Puede ser undefined
    const membershipExpiration = $(this).data('membershipExpiration');
    const membershipId = $(this).data('membershipId');

    console.log("Datos del usuario:", { userId, userName, userEmail, userPhone, registrationDate, membershipExpiration, membershipId });

    // Asignar valores al modal
    $('#userId').val(userId);
    $('#userName').val(userName);
    $('#userEmail').val(userEmail);
    $('#userPhone').val(userPhone);

    // Formatear registrationDate si está definido
    if (registrationDate) {
        const formattedRegistrationDate = new Date(registrationDate).toISOString().split('T')[0];
        $('#registrationDate').val(formattedRegistrationDate);
    } else {
        $('#registrationDate').val(''); // Asignar un valor vacío si no está definido
    }

    // Formatear membershipExpiration
    if (membershipExpiration) {
        const formattedMembershipExpiration = new Date(membershipExpiration.replace(' ', 'T')).toISOString().split('T')[0];
        $('#membershipExpiration').val(formattedMembershipExpiration);
    } else {
        $('#membershipExpiration').val('');
    }

    $('#membership').val(membershipId); // Asignar el valor correcto al select de membresía

    // Mostrar el modal
    $('#userModal').modal('show');
});

    // Manejar el envío del formulario
    $('#userForm').on('submit', function (e) {
        e.preventDefault();

        const userId = $('#userId').val();
        const membershipId = $('#membership').val();
        const membershipExpiration = $('#membershipExpiration').val();

        const formData = {
            userId: userId,
            membership_id: membershipId,
            membership_expiration: membershipExpiration,
            userName: $('#userName').val(),
            userEmail: $('#userEmail').val(),
            userPhone: $('#userPhone').val(),
            password: $('#password').val(),
        };

        $.ajax({
            url: `/admin/update_user/${userId}`,
            type: 'POST',
            data: formData,
            success: function (response) {
                if (response.success) {
                    alert(response.message);
                    $('#userModal').modal('hide');
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert('Hubo un error al actualizar el usuario.');
            }
        });
    });
});
    
    </script>

{% endblock %}