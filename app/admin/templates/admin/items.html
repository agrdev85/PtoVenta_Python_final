{% extends "admin/base.html" %}

{% block title %}
Admin Productos
{% endblock %}

{% block content %}

<!-- Mensajes flash con SweetAlert2 -->
{% with msgs = get_flashed_messages(with_categories=True) %}
{% if msgs %}
<script>
	document.addEventListener("DOMContentLoaded", function () {
		{% for category, message in msgs %}
		Swal.fire({
			title: '{{ "¡Éxito!" if category == "success" else "Error" }}',
			text: '{{ message | safe }}',
			icon: '{{ "success" if category == "success" else "error" }}',
			confirmButtonText: 'OK',
			customClass: {
				confirmButton: 'btn btn-primary'
			},
			buttonsStyling: false
		});
		{% endfor %}
	});
</script>
{% endif %}
{% endwith %}

<!-- Alertas de stock -->
{% if alerts %}
<div class="alert-container">
	{% for alert in alerts %}
	<div class="alert alert-{{ alert.category }}" id="alert-{{ alert.id }}">
		{{ alert.message }}
		<small class="text-muted" style="font-size: 0.8em;">({{ alert.created_at.strftime('%Y-%m-%d %H:%M') }})</small>
	</div>
	<script>
		setTimeout(function () {
			closeAlertSmoothly({{ alert.id }});
        }, 10000); // 10 segundos
	</script>
	{% endfor %}
</div>
{% else %}
<div class="alert alert-info">
	No hay alertas de stock en este momento.
</div>
{% endif %}

<!-- Resto del código de la tabla de Items -->

{% if not items %}
<div class="flash-error">No hay Items.</div>
<div class="d-flex justify-content-end mb-3">
	<div class="add-new btn-success btn">
		<a href="{{ url_for('admin.add') }}" data-toggle="tooltip" title="Añadir Producto" class="text-light">
			<i class="bi bi-database-fill-add"></i>
		</a>
	</div>
</div>
{% else %}
<div class="d-flex justify-content-end mb-3">
	<div class="add-new btn-success btn">
		<a href="{{ url_for('admin.add') }}" data-toggle="tooltip" title="Añadir Producto" class="text-light">
			<i class="bi bi-database-fill-add"></i>
		</a>
	</div>
</div>
<div class="table-responsive">
	<table id="items-table" class="table table-striped table-hover">
		<thead class="thead-dark">
			<tr>

				<th>Nombre</th>
				<th>Precio</th>
				<th>Costo</th>
				<th>Min | Stock</th>
				<th>Categoria</th>
				<th>Detalles</th>
				<th>Operaciones</th>
			</tr>
		</thead>
		<tbody>
			{% for item in items %}
			<tr>
				<td>{{ item.name }}</td>
				<td>{{ item.price }}</td>
				<td>{{ item.costo }}</td>
				<td>{{ item.stock_min }} | {{ item.stock }}</td>
				<td>{{ item.category }}</td>
				<td>{{ item.details[:40] | safe }}...</td>
				<td>
					<a href="{{ url_for('admin.edit', type='item', id=item.id) }}"><i
							class="bi bi-pencil-square text-success"></i></a>

					<a href="#" class="delete-item-link" data-item-id="{{ item.id }}">
								<i class="bi bi-trash3 text-danger"></i></a>

				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		// Inicializar DataTables
		var table = $('#items-table').DataTable({
			"lengthMenu": [5, 10, 25, 50],
			"ordering": true,
			"searching": true,
			"paging": true,
			"info": true,
			/* "columnDefs": [
				{
					"targets": 0, // Índice de la columna "Order ID"
					"visible": false, // Oculta la columna
					"searchable": false // También evita que sea buscable
				}
			]*/
		});

		// SweetAlert2 para confirmación de eliminación del producto
		document.querySelectorAll('.delete-item-link').forEach(link => {
			link.addEventListener('click', async function (e) {
				e.preventDefault();
				const itemId = this.getAttribute('data-item-id');
				const result = await Swal.fire({
					title: '¿Estás seguro?',
					text: 'Esta acción eliminará el producto permanentemente.',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Eliminar',
					cancelButtonText: 'Cancelar',
					customClass: {
						confirmButton: 'btn btn-danger',
						cancelButton: 'btn btn-secondary'
					},
					buttonsStyling: false
				});
				if (result.isConfirmed) {
					window.location.href = `{{ url_for('admin.delete', id=0) }}`.replace('0', itemId);
				}
			});
		});

	});

	function closeAlertSmoothly(id) {
		const el = document.getElementById('alert-' + id);
		if (el) {
			el.style.transition = 'opacity 0.5s ease';
			el.style.opacity = '0';
			setTimeout(() => el.remove(), 500); // Espera medio segundo y elimina
		}
	}

</script>
{% endif %}

{% endblock %}