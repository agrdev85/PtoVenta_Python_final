{% extends "base.html" %}

{% block title %}
    Orders - CuBaro
{% endblock %}
<script src="https://js.stripe.com/v3/"></script>
{% block content %}

    {% with msgs = get_flashed_messages(with_categories=True) %}
    {% for c, msg in msgs %}
        {% if c == 'error' %}
            <div class="flash-error">
        {% else %}
            <div class="success">
        {% endif %}
            {{ msg | safe }}</div><br>
    {% endfor %}
    {% endwith %}
    
    {% if not orders %}
        <div class="flash-error">
            Aún no has realizado ningún pedido.<br>
            <a type="button" class="mb-2 btn btn-outline-info" href="{{ url_for('home') }}">Agregar Nuevos Artículos</a>
        </div>
    {% else %}

    <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="thead-dark">
            <tr>
                <th>Orden id</th>
                <th>Orden fecha</th>
                <th>Ordenes items</th>
                <th>Total a Pagar</th>
                <th>Orden estatus</th>
                <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            {% if order.status != 'Libre' %}
            <tr data-order-id="{{ order.id }}" data-order-status="{{ order.status }}" data-order-total="0">
                <td>{{ order.id }}</td>
                <td>{{ order.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    <div class="order-items">
                        {% for item in order.items %}
                            {% set item_price = item.item.price %}
                            {% set item_total = item_price * item.quantity %}
                            <div class="my"
                                 data-item-price="{{ item_price }}"
                                 data-item-quantity="{{ item.quantity }}"
                                 data-item-total="{{ item_total }}">
                                {{ item.item.name }} - Precio: <span style="color: red;">{{ item_price }}cup</span> <span class="success">x Cantidad: {{ item.quantity }} </span>- Total: <span style="color: red;">{{ item_total }}cup</span><br>
                            </div>
                        {% endfor %}
                    </div>
                </td>
                <td class="order-total">0</td>
                <td class="order-status">
                    {% if order.status == 'Reservado' %}
                        <span style="color: green;">{{ order.status }}</span>
                    {% elif order.status == 'Pagado' %}
                        <span style="color: red;">{{ order.status }}</span>
                    {% else %}
                        {{ order.status }}
                    {% endif %}
                </td>
                <td>
                    <!-- Icono para exportar PDF -->
                    <a href="#" class="factura-link" data-order-id="{{ order.id }}">
                        <i class="bi bi-file-earmark-pdf" style="color: #dc3545; font-size: 1.5em;"></i>Factura
                    </a>                    
                </td>
                
                
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
    </div>

    <div>
        <h3>Total Neto a Pagar: <span id="total-reservado" style="color: red;" ></span></h3>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let totalReservado = 0;

            // Iterar sobre las filas de la tabla para calcular el total de cada orden
            document.querySelectorAll('tr[data-order-id]').forEach(row => {
                const status = row.getAttribute('data-order-status');
                let orderTotal = 0;

                // Sumar los totales de cada ítem
                row.querySelectorAll('.my').forEach(item => {
                    const itemTotal = parseFloat(item.getAttribute('data-item-total'));
                    orderTotal += itemTotal;
                });

                // Mostrar el total de la orden
                row.querySelector('.order-total').textContent = `${orderTotal.toFixed(0)}`;

                // Si el estado es 'Reservado', sumar al total reservado
                if (status === 'Reservado') {
                    totalReservado += orderTotal;
                }

                // Si el estado es 'Pagado', aplicar estilo
                if (status === 'Pagado') {
                // Prueba diferentes estilos
                row.style.border = '2px solid red';  // Borde rojo
                row.style.backgroundColor = '#ffdddd';  // Color de fondo rojo claro
                row.style.color = 'red';  // Texto en rojo
                }
            });

            // Mostrar el total reservado
            document.getElementById('total-reservado').textContent = `${totalReservado.toFixed(0)} CUP`;

         
        });
         
        //Generar PDF
        document.querySelectorAll('.factura-link').forEach(link => {
                link.addEventListener('click', async function (e) {
                    e.preventDefault();
                    const orderId = this.getAttribute('data-order-id');

                    const { value: formValues } = await Swal.fire({
                        title: 'Datos de la Factura',
                        html:
                            `<input id="swal-cliente" class="swal2-input" placeholder="Nombre del Cliente">
                 <input id="swal-ci" class="swal2-input" placeholder="CI">
                 <input id="swal-direccion" class="swal2-input" placeholder="Dirección del Cliente">
                 <input id="swal-emitido" class="swal2-input" placeholder="Emitido por">
                 <input id="swal-nombre-negocio" class="swal2-input" placeholder="Nombre del Negocio (Ej: CuBaro)">
                 <input id="swal-nit" class="swal2-input" placeholder="NIT (Ej: 12345678911)">
                 <input id="swal-direccion-negocio" class="swal2-input" placeholder="Dirección del Negocio">
                 <input id="swal-telefono" class="swal2-input" placeholder="Teléfono (Ej: +53 5 1234567)">
                 <input id="swal-email" class="swal2-input" placeholder="Correo (Ej: info@mipyme.cu)">`,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Generar PDF',
                        preConfirm: () => {
                            const cliente = document.getElementById('swal-cliente').value.trim();
                            const ci = document.getElementById('swal-ci').value.trim();
                            const direccion = document.getElementById('swal-direccion').value.trim();
                            const emitido = document.getElementById('swal-emitido').value.trim();
                            const nombreNegocio = document.getElementById('swal-nombre-negocio').value.trim();
                            const nit = document.getElementById('swal-nit').value.trim();
                            const direccionNegocio = document.getElementById('swal-direccion-negocio').value.trim();
                            const telefono = document.getElementById('swal-telefono').value.trim();
                            const email = document.getElementById('swal-email').value.trim();

                            if (!cliente || !ci || !direccion || !emitido || !nombreNegocio || !nit || !direccionNegocio || !telefono || !email) {
                                Swal.showValidationMessage('Por favor completa todos los campos');
                                return false;
                            }

                            return {
                                cliente, ci, direccion, emitido,
                                nombreNegocio, nit, direccionNegocio, telefono, email
                            };
                        }
                    });

                    // Si el usuario no canceló y todos los campos son válidos
                    if (formValues) {
                        const params = new URLSearchParams({
                            cliente: formValues.cliente,
                            ci: formValues.ci,
                            direccion_cliente: formValues.direccion,
                            emitido_por: formValues.emitido,
                            nombre_negocio: formValues.nombreNegocio,
                            nit: formValues.nit,
                            direccion_negocio: formValues.direccionNegocio,
                            telefono: formValues.telefono,
                            email: formValues.email
                        }).toString();

                        window.open(`/export_order/${orderId}?${params}`, '_blank');
                    }
                });
            });

   
    </script>

    {% endif %}
{% endblock %}