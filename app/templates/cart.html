{% extends "base.html" %}

{% block title %}
	Cart | CuBaro
{% endblock %}
<script src="https://js.stripe.com/v3/"></script>
{% block content %}
	<!-- Mensajes flash con SweetAlert2 -->
	{% with msgs = get_flashed_messages(with_categories=True) %}
	{% if msgs %}
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			{% for category, message in msgs %}
			Swal.fire({
				title: '{{ "¡Éxito!" if category == "success" else "Error" }}',
				html: '{{ message | safe }}',
				icon: '{{ "success" if category == "success" else "error" }}',
				confirmButtonText: 'OK',
				customClass: {
					confirmButton: 'btn btn-primary'
				},
				buttonsStyling: false
			});
			{% endfor %}
		});
	</script>
	{% endif %}
	{% endwith %}

	{% if not items %}
		<div class="flash-error">
			El carrito está vacío!<br>
			<a type="button" class="mb-2 btn btn-outline-info" href="{{ url_for('home') }}">Agregar Nuevos Artículos</a>
		</div>
	{% else %}
		<a class="right-item mb-2 btn btn-outline-info" href="{{ url_for('home') }}">Página de Artículos </a><br><br>
	{% endif %}

	<div class="items">
	{% for i in range(items|length) %}
		<div class="item">
			<div class="item-wrapper">
				<div class="img-wrapper">
					<img src="{{ items[i].image }}" class="pic">
				</div>
				<b><span class="">{{ items[i].name }}</span><br></b>
				<span class="right-item">{{ items[i].price }} CUP</span><br>
				Cantidad: 
				<span class="right-item">{{ quantity[i] }}</span><br>
				Total:
				<span class="right-item">{{ quantity[i]*items[i].price }} CUP</span>
				<br><br>
				<a href="{{ url_for('remove', id=items[i].id, quantity=quantity[i]) }}">
					<button class="remove-from-cart"> Eliminar del Carrito </button>
				</a>
			</div>
		</div>
	{% endfor %}
	</div>

	{% if price %}
	<div class="check">
		<form method="POST" action="{{ url_for('fulfill_order_view') }}" id="reserve-order-form">
			<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
			<input type="hidden" value="{{ price_ids }}" name="price_ids">
			Grand Total: {{ price }} CUP<br><br>
			<button type="button" class="bg-success btn-block btn-primary reserva-order-link"> Reservar </button>
		</form>
	</div>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			// SweetAlert2 para confirmación de reserva de órdenes
			document.querySelectorAll('.reserva-order-link').forEach(button => {
				button.addEventListener('click', async function (e) {
					e.preventDefault();
					const form = document.getElementById('reserve-order-form');
					const result = await Swal.fire({
						title: 'Confirmar Reserva',
						html: '¿Quieres reservar esta orden? Esta acción puede deshacerse eliminando la misma. <i class="bi bi-trash3 text-danger"></i>',
						icon: 'question',
						showCancelButton: true,
						confirmButtonText: 'Reservar',
						cancelButtonText: 'Cancelar',
						customClass: {
							confirmButton: 'btn btn-success',
							cancelButton: 'btn btn-secondary'
						},
						buttonsStyling: false
					});
					if (result.isConfirmed) {
						form.submit(); // Enviar el formulario
					}
				});
			});
		});
	</script>	
	{% endif %}
{% endblock %}