{% extends "base.html" %}

{% block title %}
Registro de Administrador - CuBaro
{% endblock %}

{% block content %}
<div class="row justify-content-center mt-0">
    <img id="logoAnimated" src="{{ url_for('static', filename='img/logoo.png') }}" height="100" width="150">
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card mt-2">
                <div class="card-header bg-primary text-white text-center">
                    <h3>Registrarse como Administrador</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('register_admin') }}">
                        {{ form.hidden_tag() }}

                        <div class="form-group">
                            {{ form.name.label }}
                            {{ form.name(class="form-control") }}
                            {% if form.name.errors %}
                            <div class="text-danger">
                                {% for error in form.name.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            {{ form.phone.label }}
                            {{ form.phone(class="form-control", maxlength="8", pattern="\\d{8}", inputmode="numeric", title="El teléfono debe tener exactamente 8 dígitos.") }}
                            {% if form.phone.errors %}
                            <div class="text-danger">
                                {% for error in form.phone.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            {{ form.membership.label }}
                            {{ form.membership(class="form-control") }}
                            {% if form.membership.errors %}
                            <div class="text-danger">
                                {% for error in form.membership.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            {{ form.email.label }}
                            {{ form.email(class="form-control") }}
                            {% if form.email.errors %}
                            <div class="text-danger">
                                {% for error in form.email.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group position-relative">
                            {{ form.password.label }}
                            {{ form.password(class="form-control", id="regPassword") }}
                            <span onclick="togglePassword('regPassword', 'iconRegPass')" style="cursor:pointer; position:absolute; top:38px; right:15px; color:rgb(14, 66, 238);">
                                <i class="fa fa-eye toggle-icon" id="iconRegPass" title="Mostrar contraseña"></i>
                            </span>                        
                            {% if form.password.errors %}
                            <div class="text-danger">
                                {% for error in form.password.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group position-relative">
                            {{ form.confirm.label }}
                            {{ form.confirm(class="form-control", id="regPasswordConfirm") }}
                            <span onclick="togglePassword('regPasswordConfirm', 'iconRegPassConfirm')" style="cursor:pointer; position:absolute; top:38px; right:15px; color:rgb(14, 66, 238);">
                                <i class="fa fa-eye toggle-icon" id="iconRegPassConfirm" title="Mostrar contraseña"></i>
                            </span>                        
                            {% if form.confirm.errors %}
                            <div class="text-danger">
                                {% for error in form.confirm.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group text-center">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% if master_key %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        Swal.fire({
            title: '<i class="bi bi-check-circle" style="color: #28a745;"></i> ¡Registro Exitoso!',
            html: `
                <p><i class="bi bi-key" style="color: #007bff;"></i> Tu <strong>llave maestra</strong> es:</p>
                <div id="keyBox" style="font-size: 1.6em; font-weight: bold; color: #0056b3; background: #f0f8ff; padding: 10px; border-radius: 10px; display: inline-block;">
                    {{ master_key }}
                </div>
                <br><br>
                <button onclick="copyKey('{{ master_key }}')" class="btn btn-outline-primary btn-sm"><i class="bi bi-copy"></i> Copiar clave</button>
                <br><br>
                <p><i class="bi bi-shield-alt" style="color: #17a2b8;"></i> <strong>¡Guárdala en un lugar seguro!</strong></p>
                <p>La necesitarás para recuperar tu cuenta.</p>
            `,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            showCloseButton: false,
            didOpen: () => {
                console.log("SweetAlert abierto con llave:", "{{ master_key }}");
            }
        });
    });

    function copyKey(masterKey) {
        navigator.clipboard.writeText(masterKey).then(() => {
            Swal.close(); // Cierra el primer SweetAlert
            Swal.fire({
                title: '<i class="bi bi-check-circle" style="color: #28a745;"></i> ¡Llave Copiada!',
                html: `
                    <p>Llave maestra copiada al portapapeles.</p>
                    <br>
                    <a href="{{ url_for('login') }}" class="btn btn-primary">Ir a Login</a>
                `,
                icon: 'success',
                showConfirmButton: false,
                timer: 5000, // 5 segundos antes de cerrarse automáticamente
                timerProgressBar: true,
                didClose: () => {
                    // Redirección adicional por si el usuario no hace clic
                    window.location.href = '{{ url_for("login") }}';
                }
            });
        }).catch(err => {
            Swal.fire({
                title: '<i class="bi bi-times-circle" style="color: #dc3545;"></i> Error',
                html: '<p>Error al copiar la llave.</p>',
                icon: 'error',
                showConfirmButton: true,
                confirmButtonText: 'OK',
                confirmButtonClass: 'btn btn-primary',
                buttonsStyling: false
            });
        });
    }

    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
        }
    }
</script>
{% endif %}

{% with mensajes = get_flashed_messages(with_categories=true) %}
{% if mensajes %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        {% for categoria, mensaje in mensajes %}
        console.log("Categoría: {{ categoria }}");
        console.log("Mensaje: {{ mensaje }}");
        if (categoria != "info" || !mensaje.startswith("Administrador creado")) {
            Swal.fire({
                title: '{{ "¡Éxito!" if categoria == "success" else "Información" if categoria == "info" else "Error" }}',
                html: `<p>${mensaje | safe}</p>`,
                icon: '{{ "success" if categoria == "success" else "info" if categoria == "info" else "error" }}',
                showConfirmButton: true,
                confirmButtonText: 'OK',
                confirmButtonClass: 'btn btn-primary',
                buttonsStyling: false
            });
        }
        {% endfor %}
    });
</script>
{% endif %}
{% endwith %}
{% endblock %}